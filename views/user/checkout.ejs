<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pepper Castle</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700;1,400;1,700&amp;family=Work+Sans:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/owl-carousel/1.3.3/owl.carousel.min.css">
    <link rel='stylesheet' id='bootstrap-css' href='css/bootstrap/css/bootstrap.min.css' type='text/css' media='all' />
    <!-- Font Awesome Icons CSS -->
    <link rel='stylesheet' id='font-awesome' href='css/fontawesome/css/font-awesome.min.css' type='text/css'
        media='all' />
    <!-- Owl Carousel -->
    <link rel='stylesheet' id='owl-carousel' href='js/owl-carousel/owl.carousel.min.css' type='text/css' media='all' />
    <!-- Main CSS File -->
    <link rel='stylesheet' id='caverta-style-css' href='/css/style.css' type='text/css' media='all' />
    <!-- favicons -->
    <link rel='stylesheet' id='caverta-style-css' href='/css/cart.css' type='text/css' media='all' />
    <link rel="icon" href="/images/fav.png" sizes="32x32" />
    <link rel="icon" href="/images/icons/favicon-192x192.png" sizes="192x192" />
    <link rel="apple-touch-icon-precomposed" href="/images/icons/favicon-180x180.png" />
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha384-k6RqeWeci5ZR/Lv4MR0sA0FfDOMcXy8cM4lFpbpVg5gRZxY2t+GdA1sNFA1Y+" crossorigin="anonymous"> -->
    <style>
        .checkout-contrainer {
            width: 70%;
            margin: 40px auto;
            padding: 30px;
            padding-top: 150px;
            background-color: white;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        h1 {
            text-align: center;
            color: #ff6600;
            font-size: 2.5rem;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            margin-bottom: 15px;
            color: #ff6600;
            font-size: 1.6rem;
        }

        .order-summary {
            padding: 20px;
            background-color: #ffe5cc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 40px;
        }

        .order-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .order-item img {
            width: 80px;
            height: 80px;
            border-radius: 5px;
            object-fit: cover;
        }

        .order-item-details {
            flex-grow: 1;
            margin-left: 20px;
        }

        .order-item-details p {
            margin: 5px 0;
            font-size: 1.1rem;
            color: #495057;
        }

        .order-item-price {
            font-size: 1.2rem;
            font-weight: bold;
            color: #495057;
        }

        .total-price {
            font-weight: bold;
            font-size: 1.3rem;
            color: #212529;
            text-align: right;
        }

        .address-display,
        .payment-options {
            padding: 20px;
            background-color: #ffe5cc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .address-display p {
            font-size: 1.1rem;
            margin: 8px 0;
            color: #495057;
        }

        .address-display p span {
            font-weight: bold;
        }

        .change-address-button,
        .submit-button {
            margin-top: 15px;
            padding: 12px 16px;
            font-size: 1.1rem;
            background-color: #ff6600;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .change-address-button:hover,
        .submit-button:hover {
            background-color: #cc5200;
        }

        .payment-options label {
            display: block;
            font-size: 1.1rem;
            margin: 8px 0;
            color: #495057;
        }

        input[type="radio"] {
            margin-right: 8px;
        }

        form input[type="text"],
        form button {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 1.1rem;
        }

        .submit-button {
            width: 100%;
            padding: 16px;
            background-color: #ff6600;
            font-size: 1.2rem;
        }

        .submit-button:hover {
            background-color: #cc5200;
        }
    </style>
</head>

<body class="home">
    <div class="menu-mask"></div>
    <!-- MOBILE MENU HOLDER -->
    <div class="mobile-menu-holder">
        <div class="modal-menu-container">
            <div class="exit-mobile">
                <span class="icon-bar1"></span>
                <span class="icon-bar2"></span>
            </div>
            <!-- MOBILE MENU -->
            <ul class="menu-mobile">
                <li class="menu-item menu-item-has-children">
                    <a href="#">Home</a>
                </li>
                <li class="menu-item menu-item-has-children">
                    <a href="about.html">About</a>
                </li>
                <li class="menu-item menu-item-has-children">
                    <a href="testimonials.html">Testimonials</a>
                </li>
                <li class="menu-item menu-item-has-children current-menu-item">
                    <a href="our-menu.html">Our Menu</a>
                </li>
                <li class="menu-item menu-item-has-children">
                    <a href="contact.html">Contact</a>
                </li>
                <li class="menu-item menu-item-has-children">
                    <a href="#">Sign Up</a>
                </li>
                <li class="menu-item menu-item-has-children">
                    <a href="#"><i class="fas fa-cart-plus"></i></a>
                </li>
            </ul>
            <!-- /MOBILE MENU -->
        </div>
        <!-- modal-menu-container -->
        <div class="menu-contact">
            <div class="mobile-btn">
                <a href="#" class="view-more">Order Now</a>
            </div>
            <ul class="mobile-contact">
                <li class="mobile-address">58 Ralph Ave<br />
                    New York, New York 1111
                </li>
                <li class="mobile-phone">+1 800 000 111</li>
                <li class="mobile-email"><a href="#" class="__cf_email__"
                        data-cfemail="01626e6f75606275416479606c716d642f626e6c">[email&#160;protected]</a></li>
            </ul>
            <ul class="social-media">
                <li><a class="social-facebook" href="#" target="_blank"><i class="fab fa-facebook-f"></i></a></li>
                <li><a class="social-instagram" href="https://www.instagram.com/pepper_castle_/?igshid=eddejyohhgwd"
                        target="_blank"><i class="fab fa-instagram"></i></a></li>
            </ul>
        </div>
        <!-- /menu-contact-->
    </div>
    <!-- /MOBILE MENU HOLDER -->
    <!-- HEADER -->
    <header id="header-1" class="headerHolder header-1 nav-fixed-top-cart">
        <div class="nav-button-holder">
            <button type="button" class="nav-button">
                <span class="icon-bar"></span>
            </button>
        </div>
        <!-- /nav-button-holder-->
        <!-- LOGO -->
        <div class="logo logo-1"><a href="index.html"><img class="img-fluid" src="/images/Pepper-Castle_White.png"
                    alt="Caverta" /></a></div>
        <!-- MENU -->
        <nav class="nav-holder nav-holder-1">
            <ul class="menu-nav menu-nav-1">
                <li class="menu-item menu-item-has-children">
                    <a href="/">Home</a>
                </li>
                <li class="menu-item menu-item-has-children">
                    <a href="/about">About</a>
                </li>
                <li class="menu-item menu-item-has-children">
                    <a href="/testimonials">Testimonials</a>
                </li>
                <li class="menu-item menu-item-has-children current-menu-item">
                    <a href="/our-menu">Our Menu</a>
                </li>
                <li class="menu-item menu-item-has-children">
                    <a href="/contact">Contact</a>
                </li>
            </ul>
        </nav>
        <!-- /MENU -->
        <div class="social-btn-top1">
            <% if(!isUserAuth){ %>
                <ul class="social-media social-media1 login-signup">
                    <li class="menu-item menu-item-has-children">
                        <!-- <a href="/signin">SignIn</a> -->
                    </li>
                </ul>
                <% }else{ %>
                    <ul class=" menu-nav menu-nav-1"></ul>
                    <li class="menu-item menu-item-has-children list-unstyled" style="margin-left: 50px;">
                        <a class="icon-link-white" href="#"><i class="fas fa-user"></i></a>
                    </li>
                    <li class="menu-item menu-item-has-children list-unstyled"
                        style="margin-left: 30px;margin-right: 30px;">
                        <a class="icon-link-white" href="/cart"><i class="fas fa-cart-plus" id="cartIcon"></i></a>
                    </li>
                    </ul>
                    <% } %>
                        <% if(!isUserAuth){ %>
                            <div class="btn-header btn-header1 profile-cart-btns">
                                <a href="/signin" class="view-more">Order Now</a>
                            </div>
                            <% }else{ %>
                                <div class="btn-header btn-header1 profile-cart-btns">
                                    <a href="/our-menu" class="view-more">Order Now</a>
                                </div>
                                <% } %>
        </div>
        <!-- /social-btn-top1 -->
    </header>
        <div class="container checkout-contrainer">
            <h1>Checkout</h1>

            <!-- Order Summary Section -->
            <div class="section order-summary">
                <h2>Order Summary</h2>

                <!-- Dynamically populate order items -->
                <% cartDetails.forEach(item=> { %>
                    <div class="order-item">
                        <img src="<%= item.itemDetails.image %>" alt="Product Image">
                        <div class="order-item-details">
                            <p>
                                <%= item.itemDetails.item %>
                            </p>
                            <p>Quantity: <%= item.cartItems.quantity %>
                            </p>
                        </div>
                        <p class="order-item-price">$<%= (item.itemDetails.price * item.cartItems.quantity).toFixed(2)
                                %>
                        </p>
                    </div>
                    <% }) %>

                        <!-- Total -->
                        <p class="total-price">Total: $<%= cartDetails.reduce((total, item)=> total +
                                (item.itemDetails.price * item.cartItems.quantity), 0).toFixed(2) %></p>
            </div>

            <!-- Address Display Section -->
            <div class="section">
                <h2>Shipping Address</h2>
                <div class="address-display">
                    <p>Full Name : <span id="username">
                            <%= addresses.address[0].username %>
                        </span></p>
                    <p>Phone Number : <span id="phone">
                            <%= addresses.address[0].phone %>
                        </span></p>
                    <p>Street : <span id="street">
                            <%= addresses.address[0].street %>
                        </span></p>
                    <p>City : <span id="block">
                            <%= addresses.address[0].block %>
                        </span></p>
                    <p>Unit Number : <span id="unitnum">
                            <%= addresses.address[0].unitnum %>
                        </span></p>
                    <p>Postal Code : <span id="postal">
                            <%= addresses.address[0].postal %>
                        </span></p>

                    <button class="change-address-button" onclick="toggleAddressForm()">Change Address</button>
                </div>

                <!-- Address Form (Initially Hidden) -->
                <form id="addressForm" action="/change-address" method="POST" style="display:none;">
                    <input type="text" id="newFullName" name="fullName" placeholder="Enter your full name" required>
                    <input type="text" id="newPhone" name="phone" placeholder="Enter your phone number" required>
                    <input type="text" id="newStreet" name="street" placeholder="Enter your street address" required>
                    <input type="text" id="newCity" name="city" placeholder="Enter your city" required>
                    <input type="text" id="newPostalCode" name="postalCode" placeholder="Enter your postal code"
                        required>
                    <input type="text" id="newCountry" name="country" placeholder="Enter your country" required>
                    <button type="submit" class="change-address-button">Save Address</button>
                </form>
            </div>

            <!-- Payment Method Section -->
            <div class="section">
                <h2>Payment Method</h2>
                <div class="payment-options">
                    <label>
                        <input type="radio" name="paymentMethod" value="online" required> Online Payment
                    </label>
                    <label>
                        <input type="radio" name="paymentMethod" value="cod" required> Cash on Delivery
                    </label>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="section">
                <button type="submit" class="submit-button" onclick="submitOrder()">Place Order</button>
            </div>
        </div>

        <!-- FOOTER -->
        <footer>
            <div class="container">
                <div class="footer-widgets">
                    <div class="row">
                        <!-- FOOTER COLUMN 1 -->
                        <div class="col-md-4">
                            <div class="foo-block">
                                <div id="text-2" class="widget widget-footer widget_text">
                                    <div class="textwidget">
                                        <p><img class="size-full wp-image-665" src="/images/Pepper-Castle_White.png"
                                                alt="" width="250" height="51"></p>
                                        <p>We offer such food connoisseurs the very best of North Indian cuisine that is
                                            healthy, tasty, and free from additives.</p>
                                    </div>
                                </div>
                            </div>
                            <!--foo-block-->
                        </div>
                        <!--col-md-3-->
                        <!-- FOOTER COLUMN 2 -->
                        <div class="col-md-3">
                            <div class="foo-block">
                                <div id="text-3" class="widget widget-footer widget_text">
                                    <h5 class="widgettitle"><span>Address</span></h5>
                                    <div class="textwidget">
                                        <p>33 Lorong liput<br> 277744 Singapore
                                        </p>
                                        <p style="white-space: nowrap;"><i class="fas fa-phone-alt"></i>+65 97440747<br>
                                            <i class="fas fa-envelope"></i><a href="#">peppercastle@hotmail.com</a>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <!--foo-block-->
                        </div>
                        <!--col-md-3-->

                        <div class="col-md-3">
                            <div class="foo-block foo-last">
                                <div id="text-5" class="widget widget-footer widget_text">
                                    <h5 class="widgettitle"><span>Quick Links</span></h5>
                                    <div class="textwidget ftr-menu">
                                        <ul>
                                            <li><a href="index.html">-Home</a></li>
                                            <li><a href="about.html">-About</a></li>
                                            <li><a href="testimonials.html">-Testimonials</a></li>
                                            <li><a href="#">-Our Menu</a></li>
                                            <li><a href="contact.html">-Contact</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <!--foo-block-->
                        </div>
                        <!-- FOOTER COLUMN 3 -->
                        <div class="col-md-2">
                            <div class="foo-block">
                                <div id="text-4" class="widget widget-footer widget_text">
                                    <h5 class="widgettitle"><span>Hours</span></h5>
                                    <div class="textwidget">
                                        <p style="white-space: nowrap;">Monday – Sunday<br>
                                            11:00 AM - 11:00 PM
                                        </p>
                                    </div>
                                    <ul class="footer-social">
                                        <li><a class="social-facebook" href="#" target="_blank"><i
                                                    class="fab fa-facebook-f"></i></a></li>
                                        <li><a class="social-instagram"
                                                href="https://www.instagram.com/pepper_castle_/?igshid=eddejyohhgwd"
                                                target="_blank"><i class="fab fa-instagram"></i></a></li>
                                    </ul>
                                </div>
                            </div>
                            <!--foo-block-->
                        </div>
                        <!--col-md-3-->
                        <!-- FOOTER COLUMN 4 -->

                        <!--col-md-3-->
                    </div>
                    <!--row-->
                </div>
                <!-- footer-widgets -->
                <div class="copyright">
                    <!-- COPYRIGHT -->
                    <div class="footer-copy">
                        <p>© 2023 - Pepper Castle. All Rights Reserved.</p>
                    </div>
                    <!-- SOCIAL ICONS -->

                </div>
                <!--copyright-->
            </div>
            <!--container-->
        </footer>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            $(document).ready(function () {
                updateCartCount();
            });
            function submitOrder() {
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                const orderItems = `<%- JSON.stringify(cartDetails) %>`;
                const userId = `<%= userId %>`;
                const structuredAddress = `<%= addresses.address[0].structuredAddress %>`;

                const address = {
                    username: document.getElementById('username').textContent,
                    phone: document.getElementById('phone').textContent,
                    street: document.getElementById('street').textContent,
                    block: document.getElementById('block').textContent,
                    unitnum: document.getElementById('unitnum').textContent,
                    postal: document.getElementById('postal').textContent,
                    structuredAddress: structuredAddress
                };

                const orderData = {
                    orderItems: orderItems, // Should be a JavaScript object, not a string
                    paymentMethod: paymentMethod,
                    address: address,
                    userId: userId
                };

                // Send AJAX POST request to create an order
                fetch('/api/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (paymentMethod === 'online') {
                                window.location.href = data.paymentUrl; // Stripe redirect URL
                            } else {
                                alert('Order placed with Cash on Delivery!');
                            }
                        } else {
                            alert('Error placing order: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }





            function updateCartCount() {
                const userId = `<%= userId %>`;  // Make sure userId is defined here
                if (!userId) {
                    console.error("userId is not defined!");
                    return;
                }

                $.ajax({
                    url: '/api/itemCount',
                    method: 'GET',
                    data: { userId: userId },
                    success: function (response) {
                    console.log("Cart Count Response:", response);
                    cartCountDisplay(response.cartItemCount);  // Pass the cart item count directly
                    },
                    error: function () {
                    console.error("Error fetching cart count");
                    }
                });
            }
            function cartCountDisplay(cartItemCount) {
            const cartIcon = document.getElementById('cartIcon');

            // Remove any existing counter to avoid duplication
            const existingCounter = cartIcon.querySelector('span');
            if (existingCounter) {
                cartIcon.removeChild(existingCounter);
            }

            // Create a new span element for the cart count
            const counter = document.createElement('span');
            counter.style.position = 'absolute';
            counter.style.borderRadius = '50%';
            counter.style.backgroundColor = 'var(--headings-color)';
            counter.style.width = '14px';
            counter.style.height = '14px';
            counter.style.top = '20px';
            // counter.style.right = '0'; 
            counter.style.textAlign = 'center';
            counter.style.lineHeight = '15px';
            counter.style.fontSize = '10px';
            counter.style.color = '#fff';
            counter.textContent = cartItemCount;  // Use the count returned from the server

            // Append the counter to the cart icon
            cartIcon.appendChild(counter);
        }

        </script>


    </body>

</html>