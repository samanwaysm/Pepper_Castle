<!DOCTYPE html>
<html lang="en-US">
<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Pepper Castle</title>
      <!-- Google Fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com/">
      <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700;1,400;1,700&amp;family=Work+Sans:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
      <!-- Bootstrap CSS -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/owl-carousel/1.3.3/owl.carousel.min.css">
      <link rel='stylesheet' id='bootstrap-css'  href='css/bootstrap/css/bootstrap.min.css' type='text/css' media='all' />
      <!-- Font Awesome Icons CSS -->
      <link rel='stylesheet' id='font-awesome'  href='css/fontawesome/css/font-awesome.min.css' type='text/css' media='all' />
      <!-- Owl Carousel -->
      <link rel='stylesheet' id='owl-carousel'  href='js/owl-carousel/owl.carousel.min.css' type='text/css' media='all' />
      <!-- Main CSS File -->
      <link rel='stylesheet' id='caverta-style-css'  href='/css/style.css' type='text/css' media='all' />
      <!-- favicons -->
      <link rel='stylesheet' id='caverta-style-css'  href='/css/cart.css' type='text/css' media='all' />
      <link rel="icon" href="/images/fav.png" sizes="32x32" />
      <link rel="icon" href="/images/icons/favicon-192x192.png" sizes="192x192" />
      <link rel="apple-touch-icon-precomposed" href="/images/icons/favicon-180x180.png" />
      <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha384-k6RqeWeci5ZR/Lv4MR0sA0FfDOMcXy8cM4lFpbpVg5gRZxY2t+GdA1sNFA1Y+" crossorigin="anonymous"> -->
   </head>
   <body class="home">
      <div class="menu-mask"></div>
      <!-- MOBILE MENU HOLDER -->
      <div class="mobile-menu-holder">
         <div class="modal-menu-container">
            <div class="exit-mobile">
               <span class="icon-bar1"></span>
               <span class="icon-bar2"></span>
            </div>
            <!-- MOBILE MENU -->
            <ul class="menu-mobile">
               <li class="menu-item menu-item-has-children">
                    <a href="#">Home</a>
                </li>
                <li class="menu-item menu-item-has-children">
                    <a href="about.html">About</a>
                </li>
                <li class="menu-item menu-item-has-children">
                    <a href="testimonials.html">Testimonials</a>
                </li>
                <li class="menu-item menu-item-has-children current-menu-item">
                    <a href="our-menu.html">Our Menu</a>
                </li>
                <li class="menu-item menu-item-has-children">
                    <a href="contact.html">Contact</a>
                </li>
                <li class="menu-item menu-item-has-children">
                    <a href="#">Sign Up</a>
                </li>
                <li class="menu-item menu-item-has-children">
                    <a href="#"><i class="fas fa-cart-plus"></i></a>
                </li>
            </ul>
            <!-- /MOBILE MENU -->
         </div>
         <!-- modal-menu-container -->
         <div class="menu-contact">
            <div class="mobile-btn">
                <a href="#" class="view-more">Order Now</a>
            </div>
            <ul class="mobile-contact">
               <li class="mobile-address">58 Ralph Ave<br />
                  New York, New York 1111
               </li>
               <li class="mobile-phone">+1 800 000 111</li>
               <li class="mobile-email"><a href="#" class="__cf_email__" data-cfemail="01626e6f75606275416479606c716d642f626e6c">[email&#160;protected]</a></li>
            </ul>
            <ul class="social-media">
               <li><a class="social-facebook" href="#" target="_blank"><i class="fab fa-facebook-f"></i></a></li>
               <li><a class="social-instagram" href="https://www.instagram.com/pepper_castle_/?igshid=eddejyohhgwd" target="_blank"><i class="fab fa-instagram"></i></a></li>
            </ul>
         </div>
         <!-- /menu-contact-->
      </div>
      <!-- /MOBILE MENU HOLDER -->
      <!-- HEADER -->
      <header id="header-1" class="headerHolder header-1 nav-fixed-top-cart">
         <div class="nav-button-holder">
            <button type="button" class="nav-button">
            <span class="icon-bar"></span>
            </button>
         </div>
         <!-- /nav-button-holder-->
         <!-- LOGO -->
         <div class="logo logo-1"><a href="index.html"><img class="img-fluid" src="/images/Pepper-Castle_White.png" alt="Caverta" /></a></div>
         <!-- MENU -->
         <nav class="nav-holder nav-holder-1">
            <ul class="menu-nav menu-nav-1">
               <li class="menu-item menu-item-has-children">
                    <a href="/">Home</a>
                </li>
                <li class="menu-item menu-item-has-children">
                    <a href="/about">About</a>
                </li>
                <li class="menu-item menu-item-has-children">
                    <a href="/testimonials">Testimonials</a>
                </li>
                <li class="menu-item menu-item-has-children">
                    <a href="/our-menu">Our Menu</a>
                </li>
                <li class="menu-item menu-item-has-children">
                    <a href="/contact">Contact</a>
                </li>
            </ul>
         </nav>
         <!-- /MENU --> 
         <div class="social-btn-top1">
            <% if(!isUserAuth){ %>
               <ul class="social-media social-media1 login-signup">
                  <li class="menu-item menu-item-has-children">
                      <!-- <a href="/signin">SignIn</a> -->
                  </li>
              </ul>
            <% }else{ %>
            <ul class=" menu-nav menu-nav-1"></ul>
               <li class="menu-item menu-item-has-children list-unstyled" style="margin-left: 50px;">
                  <a class="icon-link-white" href="#"><i class="fas fa-user"></i></a>
               </li>
               <li class="menu-item menu-item-has-children list-unstyled current-menu-item" style="margin-left: 30px;margin-right: 30px;">
                  <a class="icon-link-white" href="/cart"><i class="fas fa-cart-plus" id="cartIcon"></i></a>
               </li>
            </ul>
            <% } %>
            <% if(!isUserAuth){ %>
            <div class="btn-header btn-header1 profile-cart-btns"> 
                <a href="/signin" class="view-more">Order Now</a>
            </div>
            <% }else{ %>
               <div class="btn-header btn-header1 profile-cart-btns"> 
                  <a href="/our-menu" class="view-more">Order Now</a>
              </div>
            <% } %>
         </div>
            <!-- /social-btn-top1 --> 
      </header> 
      <!-- WRAP CONTENT -->
        <div class="container-wrapper">
            <div class="cart-container">
                <div class="product-section">
                    <% if (cart && cart.length > 0) { %>
                        <% cart.forEach(item => { %>
                            <div class="product-item" data-item-id="<%= item.cartItems.itemId %>">
                                <div class="product-details">
                                    <img src="<%= item.itemDetails.image[0] %>" alt="<%= item.itemDetails.item %>">
                                    <span class="product-name"><%= item.itemDetails.item %></span>
                                </div>
                                <div class="quantity-selector">
                                    <button class="decrease-qty" data-item-id="<%= item.cartItems.itemId %>">-</button>
                                    <input type="text" class="quantity-input" value="<%= item.cartItems.quantity %>" data-item-id="<%= item.cartItems.itemId %>" readonly>
                                    <button class="increase-qty" data-item-id="<%= item.cartItems.itemId %>">+</button>
                                </div>
                                <div class="item-total-price">
                                    <span>S$<%= (item.itemDetails.price * item.cartItems.quantity).toFixed(2) %></span>
                                    <i class="fas fa-trash delete-icon" data-item-id="<%= item.cartItems.itemId %>"></i>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="empty-cart text-center align-items-center" id="emptyCartMessage">
                            <p>Your cart is empty.</p>
                            <a href="/our-menu" class="add-products-link">Add Products</a>
                        </div>
                    <% } %>
                </div>

                <div class="summary-section">
                    <div class="summary">
                        <h3>Order Summary</h3>
                        <div class="summary-item">
                            <span>Subtotal</span>
                            <span class="subtotal">S$<%= cart.reduce((sum, item) => sum + (item.itemDetails.price * item.cartItems.quantity), 0).toFixed(2) %></span>
                        </div>
                        <div class="summary-item">
                            <span>Shipping</span>
                            <span>Free</span>
                        </div>
                        <div class="summary-item">
                            <strong>Total</strong>
                            <strong class="total">S$<%= cart.reduce((sum, item) => sum + (item.itemDetails.price * item.cartItems.quantity), 0).toFixed(2) %></strong>
                        </div>
                        <a href="/checkout"><button class="checkout-btn">Checkout</button></a>
                    </div>
                </div>
            </div>
        </div>
      <!-- /WRAP CONTENT -->
      <!-- FOOTER -->
      <footer>
         <div class="container">
            <div class="footer-widgets">
               <div class="row">
                  <!-- FOOTER COLUMN 1 -->
                  <div class="col-md-4">
                     <div class="foo-block">
                        <div id="text-2" class="widget widget-footer widget_text">
                           <div class="textwidget">
                              <p><img class="size-full wp-image-665" src="/images/Pepper-Castle_White.png" alt="" width="250" height="51"></p>
                              <p>We offer such food connoisseurs the very best of North Indian cuisine that is healthy, tasty, and free from additives.</p>
                           </div>
                        </div>
                     </div>
                     <!--foo-block-->
                  </div>
                  <!--col-md-3-->
                  <!-- FOOTER COLUMN 2 -->
                  <div class="col-md-3">
                     <div class="foo-block">
                        <div id="text-3" class="widget widget-footer widget_text">
                           <h5 class="widgettitle"><span>Address</span></h5>
                           <div class="textwidget">
                              <p>33 Lorong liput<br> 277744 Singapore
                              </p>
                              <p style="white-space: nowrap;"><i class="fas fa-phone-alt"></i>+65 97440747<br>
                                 <i class="fas fa-envelope"></i><a href="#">peppercastle@hotmail.com</a>
                              </p>
                           </div>
                        </div>
                     </div>
                     <!--foo-block-->
                  </div>
                  <!--col-md-3-->
                  
                   <div class="col-md-3">
                     <div class="foo-block foo-last">
                        <div id="text-5" class="widget widget-footer widget_text">
                           <h5 class="widgettitle"><span>Quick Links</span></h5>
                           <div class="textwidget ftr-menu">
                              <ul>
                                 <li><a href="index.html">-Home</a></li>
                                 <li><a href="about.html">-About</a></li>
                                 <li><a href="testimonials.html">-Testimonials</a></li>
                                 <li><a href="#">-Our Menu</a></li>
                                 <li><a href="contact.html">-Contact</a></li>
                              </ul>
                           </div>
                        </div>
                     </div>
                     <!--foo-block-->
                  </div>
                  <!-- FOOTER COLUMN 3 -->
                  <div class="col-md-2">
                     <div class="foo-block">
                        <div id="text-4" class="widget widget-footer widget_text">
                           <h5 class="widgettitle"><span>Hours</span></h5>
                           <div class="textwidget">
                              <p style="white-space: nowrap;">Monday – Sunday<br>
                                 11:00 AM - 11:00 PM
                              </p>
                           </div>
                           <ul class="footer-social">
                              <li><a class="social-facebook" href="#" target="_blank"><i class="fab fa-facebook-f"></i></a></li>
                              <li><a class="social-instagram" href="https://www.instagram.com/pepper_castle_/?igshid=eddejyohhgwd" target="_blank"><i class="fab fa-instagram"></i></a></li>
                           </ul>
                        </div>
                     </div>
                     <!--foo-block-->
                  </div>
                  <!--col-md-3-->
                  <!-- FOOTER COLUMN 4 -->
                 
                  <!--col-md-3-->
               </div>
               <!--row-->
            </div>
            <!-- footer-widgets -->
            <div class="copyright">
               <!-- COPYRIGHT -->
               <div class="footer-copy">
                  <p>© 2023 - Pepper Castle. All Rights Reserved.</p>
               </div>
               <!-- SOCIAL ICONS -->
               
            </div>
            <!--copyright-->
         </div>
         <!--container-->
      </footer>
        <!-- /FOOTER -->
        <div class="scrollup">
            <a class="scrolltop" href="#">
            <i class="fa fa-chevron-up"></i>
            </a>
        </div>
        <!-- JS --> 
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <script>
        const userId = '<%= userId %>';
        

        function updateCartUI(itemId, newQuantity, itemPrice) {
            const itemElement = $(`.product-item[data-item-id="${itemId}"]`);
            const quantityInput = itemElement.find('.quantity-input');
            const itemTotalPrice = itemElement.find('.item-total-price');

            // Update quantity input and item total price
            quantityInput.val(newQuantity);
            itemTotalPrice.find('span').html(`S$${(itemPrice).toFixed(2)}`);

            // Update subtotal and total
            let newSubtotal = 0;
            $('.item-total-price span').each(function() {
                newSubtotal += parseFloat($(this).text().replace('S$', '').trim());
            });

            // Update the displayed subtotal and total
            $('.subtotal').text(`S$${newSubtotal.toFixed(2)}`);
            $('.total').text(`S$${newSubtotal.toFixed(2)}`);
        }

        $(document).on('click', '.increase-qty, .decrease-qty', function() {
            const itemId = $(this).data('item-id');
            const action = $(this).hasClass('increase-qty') ? 'increase' : 'decrease';

            const quantityInput = $(`.product-item[data-item-id="${itemId}"] .quantity-input`);
            let currentQuantity = parseInt(quantityInput.val(), 10);
            let newQuantity = action === 'increase' ? currentQuantity + 1 : currentQuantity - 1;

            if (newQuantity < 1) {
                newQuantity = 1;
            }

            $.ajax({
                url: '/api/update-cart',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ itemId, action, userId }),
                success: function(data) {
                    if (data.success) {
                        const { newQuantity, itemPrice } = data; // Assuming API returns new quantity and updated price
                        updateCartUI(itemId, newQuantity, itemPrice);
                    } else {
                        console.error('Error:', data.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error updating quantity:', error);
                }
            });
        });

        $(document).ready(function () {
            // Fetch and display the initial cart count on page load
            updateCartCount();
        });

        $(document).on('click', '.delete-icon', function() {
            const itemId = $(this).data('item-id');

            $.ajax({
                url: '/api/remove-from-cart',
                method: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({ itemId, userId }),
                success: function(data) {
                    if (data.success) {
                        $(`.product-item[data-item-id="${itemId}"]`).remove(); // Remove item from UI
                        // Update subtotal and total accordingly
                        updateCartSummary();
                        updateCartCount();
                    } else {
                        console.error('Error:', data.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error removing item:', error);
                }
            });
        });

        function updateCartSummary() {
            let newSubtotal = 0;
            $('.item-total-price span').each(function() {
                newSubtotal += parseFloat($(this).text().replace('S$', '').trim());
            });

            // Update displayed subtotal and total
            $('.subtotal').text(`S$${newSubtotal.toFixed(2)}`);
            $('.total').text(`S$${newSubtotal.toFixed(2)}`);
        }

        function updateCartCount() {
         const userId = `<%= userId %>`;  // Make sure userId is defined here
         if (!userId) {
            console.error("userId is not defined!");
            return;
         }

         $.ajax({
            url: '/api/itemCount',
            method: 'GET',
            data: { userId: userId },
            success: function (response) {
               console.log("Cart Count Response:", response);
               cartCountDisplay(response.cartItemCount);  // Pass the cart item count directly
            },
            error: function () {
               console.error("Error fetching cart count");
            }
         });
      }

        function cartCountDisplay(cartItemCount) {
            const cartIcon = document.getElementById('cartIcon');

            // Remove any existing counter to avoid duplication
            const existingCounter = cartIcon.querySelector('span');
            if (existingCounter) {
                cartIcon.removeChild(existingCounter);
            }

            // Create a new span element for the cart count
            const counter = document.createElement('span');
            counter.style.position = 'absolute';
            counter.style.borderRadius = '50%';
            counter.style.backgroundColor = 'var(--headings-color)';
            counter.style.width = '14px';
            counter.style.height = '14px';
            counter.style.top = '20px';
            // counter.style.right = '0'; 
            counter.style.textAlign = 'center';
            counter.style.lineHeight = '15px';
            counter.style.fontSize = '10px';
            counter.style.color = '#fff';
            counter.textContent = cartItemCount;  // Use the count returned from the server

            // Append the counter to the cart icon
            cartIcon.appendChild(counter);
        }

    </script>
      
      <!-- Removed redundant jQuery script -->
      <!-- <script src='js/jquery.js'></script> -->
      <script src='js/jquery-migrate.min.js'></script>
      <script src='css/bootstrap/js/popper.min.js'></script>
      <script src='css/bootstrap/js/bootstrap.min.js'></script>
      <script src='js/jquery.easing.min.js'></script>
      <script src='js/jquery.fitvids.js'></script>
      <script src='js/owl-carousel/owl.carousel.min.js'></script>
      <script src='js/jquery.magnific-popup.min.js'></script>
      <!-- MAIN JS -->
      <script src='js/init.js'></script>
      <!-- CONTACT FORM JS -->
      <script src='js/jquery.form.min.js'></script>
      <script src='js/contactform-home.js'></script>

    </body>

</html>
